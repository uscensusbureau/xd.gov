<!DOCTYPE html> <!--[if lt IE 9]><html class="lt-ie9"><![endif]--> <!--[if gt IE 8]><!--><html lang="en"><!--<![endif]--><head><meta charset="utf-8"><meta property="og:title" content="xD - U.S. Census Bureau | Privacy-preserving model auditing demo: technical deep dive"><meta name="image" property="og:image" content="https://uscensusbureau.github.io/assets/img/news/privacy-preserving-model-auditing-demo-technical-deep-dive.jpg"><meta property="og:description" content="xD is an emerging technologies group that’s advancing the delivery of data-driven services through new and transformative technologies."><meta property="og:url" content="https://uscensusbureau.github.io/blog/ppma-deep-dive/"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="xD - US Census Bureau"><meta name="twitter:title" content="xD - U.S. Census Bureau | Privacy-preserving model auditing demo: technical deep dive"><meta name="twitter:site" content="xD - US Census Bureau"><meta name="twitter:image" content="https://uscensusbureau.github.io/assets/img/news/privacy-preserving-model-auditing-demo-technical-deep-dive.jpg"><meta name="twitter:image:alt" content="Example Cryptographic Protocol"><meta property="twitter:description" content="xD is an emerging technologies group that’s advancing the delivery of data-driven services through new and transformative technologies."><title>xD - U.S. Census Bureau | Privacy-preserving model auditing demo: technical deep dive</title><meta name="description" content="xD is an emerging technologies group that’s advancing the delivery of data-driven services through new and transformative technologies."> <!-- Author --> <!-- Date --><meta name="date" content="2025-03-28 14:08:39 +0000"" scheme="YYYY-MM-DD"> <!-- Tags --><meta name="keywords" content=""><link rel="canonical" href="https://uscensusbureau.github.io/blog/ppma-deep-dive/" /> <script src="/assets/js/uswds/uswds.min.js"></script> <!--[if lt IE 9]> <script src="/assets/js/vendor/html5shiv.js"></script> <script src="/assets/js/vendor/respond.js"></script> <script src="/assets/js/vendor/selectivizr-min.js"></script> <![endif]--><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Favicons ================================================== --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"> <!-- CSS =================================================== --> <script src="/assets/uswds/dist/js/uswds-init.min.js"></script><link rel="stylesheet" href="/assets/uswds/dist/css/uswds.min.css" media="all" /><link rel="stylesheet" href="/assets/css/main.css" media="all" /><link rel="preconnect" href="https://www.googletagmanager.com/gtag/js?id=G-3P989H6XN2" /> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-3P989H6XN2'); </script> <script async type="text/javascript" id="_fed_an_ua_tag" src=https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=DOC&amp;subagency=CEN></script><body class="blog page-privacy-preserving-model-auditing-demo-technical-deep-dive "><div class="site-banner usa-banner"><div class="usa-accordion"><header class="usa-banner__header"><div class="usa-banner__inner maxw-none"><div class="grid-col-auto"> <img class="usa-banner__header-flag" src="/assets/img/uswds/us_flag_small.png" alt="U.S. flag"></div><div class="grid-col-fill tablet:grid-col-auto"><p class="usa-banner__header-text">An official website of the United States Government</p><p class="usa-banner__header-action" aria-hidden="true">Here’s how you know</p></div><button class="usa-accordion__button usa-banner__button" aria-expanded="false" aria-controls="gov-banner"> <span class="usa-banner__button-text">Here’s how you know</span> </button></div></header><div class="usa-banner__content usa-accordion__content" id="gov-banner" hidden=""><div class="grid-row grid-gap-lg"><div class="usa-banner__guidance tablet:grid-col-6"> <img class="usa-banner__icon usa-media-block__img" src="/assets/img/uswds/icon-dot-gov.svg" alt="Dot gov"><div class="usa-media-block__body"><p> <strong>The .gov means it’s official.</strong> <br> Federal government websites often end in .gov or .mil. Before sharing sensitive information, make sure you’re on a federal government site.</p></div></div><div class="usa-banner__guidance tablet:grid-col-6"> <img class="usa-banner__icon usa-media-block__img" src="/assets/img/uswds/icon-https.svg" alt="Https"><div class="usa-media-block__body"><p> <strong>The site is secure.</strong> <br> The <strong>https://</strong> ensures that you are connecting to the official website and that any information you provide is encrypted and transmitted securely.</p></div></div></div></div></div></div><header class="usa-header site-header"><div class="usa-navbar site-header-navbar"><div class="grid-row"><div class="hero-left grid-col-5"><div class="usa-logo site-logo" id="logo"> <em class="usa-logo__text"> <a class="margin-right-05" href="/" title="Home" aria-label="United States Web Design System home"> <span aria-hidden="true" class="site-title-short">xD</span> <span class="site-title">xD | U.S. Census Bureau</span> </a> </em></div></div><div class="hero-right grid-col-7"> <button class="usa-menu-btn">Menu</button><nav role="navigation" class="usa-nav"> <button class="usa-nav__close"> <span class="usa-sr-only">Close</span> </button><div class="usa-nav-inner"><ul class="usa-nav-primary usa-accordion"><li> <a class=" usa-nav-link " href="/about/"> <span>About</span> </a><li> <a class=" usa-nav-link " href="/projects/"> <span>Projects</span> </a><li> <a class=" usa-nav-link " href="/news/"> <span>News</span> </a><li> <a href="https://public.govdelivery.com/accounts/USCENSUS/signup/34927" class="usa-button usa-button-black" target="_blank"><span class="visually-hidden">Subscribe to the </span>Mailing List</a></ul></div></nav></div></div></div></header><div class="usa-overlay"></div><main class="main-content" id="main-content"><section><article class="grid-container"><div class="grid-row grid-gap-lg news-row"><div class="tablet:grid-col-8 news-content-container"><header><div class="breadcrumb">Blog Post</div><h1>Privacy-preserving model auditing demo: technical deep dive</h1><p class="post-author">By Tomo Lazovich</p><p class="news-date">February 07, 2025</p></header><div class="news-content"><p>In my last blog post, I gave an overview of how we used an existing open source cryptographic protocol for the use case of measuring demographic disparities in a model’s performance. If you haven’t read that one, you can find it <a href="/blog/privacy-preserving-model-auditing">here</a>. In this post, we’ll dive more into some of the engineering that it took to get the demo working on GSA’s <a href="https://cloud.gov/">cloud.gov</a> infrastructure. If you’re interested in looking at the demo code, you can find it on <a href="https://github.com/XDgov/privacy-preserving-model-auditing-demo">Github</a>.</p><h2 id="introduction-what-were-the-roadblocks">Introduction: what were the roadblocks?</h2><p>As a reminder, for this demo, we decided to use the open source <a href="https://github.com/facebookresearch/Private-ID">Private-ID</a> library, a Rust library that implements several private join protocols. After getting the package running locally in my OS X development environment using their sample data, my next step was to try to get it working in the cloud. The GSA cloud.gov infrastructure is based on <a href="https://www.cloudfoundry.org/">CloudFoundry</a>, so you’ll notice in the repository that all the deployment scripts used CloudFoundry commands like <code class="language-html highlighter-rouge">cf push</code>. At a very basic level, we’re trying to deploy one end of the computation to the cloud and run the other end of the computation locally and have those two ends communicate with one another.</p><p>In this post, I’ll focus on three main issues that I had to figure out to get this demo running:</p><ul><li><p><strong>Cross-compilation</strong>: My local development environment is OS X, but the cloud servers run Linux. So, I first needed to figure out how to cross-compile a Rust binary for a Linux target on my Macbook.</p><li><p><strong>gRPC -&gt; REST API</strong>: After some wrangling with support, I discovered that cloud.gov’s load balancers do not support HTTP2, meaning that the default gRPC communications between the server and client wouldn’t work. Therefore, I needed to figure out how to wrap the library’s gRPC endpoints in a REST API. This involved two steps: 1) creating a proxy server to translate REST API requests to gRPC, and 2) modifying the client-side code in the Rust library to send REST API requests instead of gRPC.</p><li><p><strong>Networking configuration</strong>: The final step was figuring out how to configure network routes with CloudFoundry so that the proxy server and the gRPC server had permission to communicate with each other.</p></ul><p>I’ll go into each of these in more detail below.</p><h2 id="cross-compiling-rust-binaries-from-os-x-to-linux">Cross-compiling Rust binaries from OS X to Linux</h2><p>The first issue I spent some time wrangling with was how to get the Rust binary built for the cloud Linux target. If you know anything about CloudFoundry, you know that it is based around <a href="https://docs.cloudfoundry.org/buildpacks/system-buildpacks.html">buildpacks</a>, which support specific languages and frameworks and allow you to configure the build of your binary as part of deployment to the cloud. You might immediately wonder why we needed to cross-compile at all - why couldn’t we just use a buildpack? First off, Rust doesn’t have a buildpack that is officially supported by CloudFoundry. Thankfully, there is an open source Rust buildpack on <a href="https://github.com/alphagov/cf-buildpack-rust">Github</a>. I first tried deploying with this buildpack rather than cross-compiling locally. In principle, this solution would work, but in my case the Rust build process was very memory-intensive and we were working in a sandbox environment with limited RAM available, so my builds would often get about halfway through and fail due to running out of memory. Because of this constraint, I ended up deciding to build locally and deploy the binary to the cloud using CloudFoundry’s <a href="https://docs.cloudfoundry.org/buildpacks/binary/index.html">binary buildpack</a>.</p><p>Once I decided that I needed to build locally, I then turned to the question of how to cross-compile Rust from OS X to Linux. After experimenting with a few options, the one that I found easiest to use was a Rust compiler called <a href="https://github.com/cross-rs/cross">Cross</a>. Cross works by fetching a docker container for the environment you need to compile into and running the compilation within that container. Once Cross is installed, the cross-compilation is a simple one-liner:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="syntax"><code>cross build <span class="nt">--release</span> <span class="nt">--target</span> x86_64-unknown-linux-gnu
</code></pre></div></div><p>This command puts the binary in the directory <code class="language-html highlighter-rouge">target/x86_64-unknown-linux-gnu/release/</code>.</p><p>After this, you now have a Linux binary that can be pushed to the cloud for the server (or “company”) side of the cryptographic protocol.</p><h2 id="building-a-rest-api-around-the-grpc-endpoints">Building a REST API around the gRPC endpoints</h2><p>My next step was to wrap the gRPC endpoints of the server in a REST API because the client (or “partner”) side was not able to communicate via HTTP2 with the server because cloud.gov’s load balancers did not support the protocol. Note, however, that HTTP2 traffic was supported <em>internally</em>, meaning that what I needed was a proxy server that would receive commands from the client via a REST API and translate those requests to gRPC to send to the RPC server that actually runs the protocol. Now, this does mean that we are essentially giving up all the advantages that come with gRPC, particularly as it relates to data streaming, but the purpose of this demo was really to show what was possible rather than building the optimal system.</p><p>Luckily, there is a wonderful tool called <a href="https://grpc-ecosystem.github.io/grpc-gateway/">grpc-gateway</a> that is built for exactly this purpose. This package takes in the proto files that define the gRPC procedures and generates stubs in Go that do the translation from the REST API to the appropriate gRPC call. All you need to do is annotate your proto file correctly, as you can see in <a href="https://github.com/XDgov/privacy-preserving-model-auditing-demo/blob/main/pjc-proxy-go/proto/pjc-proxy/pjc.proto#L62">this example</a> in our repo. After that, the last step is to create a main Go file that acts as the proxy server and calls the appropriate generated code like the one we have <a href="https://github.com/XDgov/privacy-preserving-model-auditing-demo/blob/main/pjc-proxy-go/main.go">here</a>. For more details on how do actually run the generation using a tool called <code class="language-html highlighter-rouge">buf</code>, you can see the repo’s <a href="https://github.com/XDgov/privacy-preserving-model-auditing-demo?tab=readme-ov-file#generate-go-proxy-server-code-and-cross-compile-proxy-binary">documentation</a>. I find a figure from <code class="language-html highlighter-rouge">grpc-gateway</code>’s documentation to be particularly illustrative of how the proxying works:</p><p><img src="/assets/img/news/privacy-preserving-model-auditing-demo-technical-deep-dive.jpg" alt="proxy configuration" /></p><p>The Go proxy is deployed as a separate app on cloud.gov to talk to the RPC server app that we compiled above. For this deployment we also build the Go server locally (thankfully the Go compiler supports cross-compilation) and use the binary buildpack as we did with the RPC server.</p><h2 id="updating-rust-client-to-query-rest-api">Updating Rust client to query REST API</h2><p>With the gRPC server now wrapped in a REST API, we turn the client or “partner” side of the computation. In the original library, the client Rust code makes gRPC calls to the server. With our server now wrapped in a REST API, we need our client to format the data and make appropriate calls to that API. This involves first making sure that the data, originally transferred in protobufs, are correctly serialized as JSON to send to the new API. To do this, we add prefixes to some buffer definitions to serialize the data as base64, which is what the Go proxy expects (and also what it sends back when you query for results from the API). You can see how that is done <a href="https://github.com/XDgov/privacy-preserving-model-auditing-demo/commit/14719b4f50b502b9a4f0408ef144c53d926bed7d#diff-63cdbbd02ee60550190dfcc179aa3e7af8abc22f5598a87e1c32d1c33a0795eaR16">here</a> and <a href="https://github.com/XDgov/privacy-preserving-model-auditing-demo/commit/14719b4f50b502b9a4f0408ef144c53d926bed7d#diff-6eb41e27fe9db4f78129034b9f3df8969db643f73e8f2561e386495fcdaecd94R14">here</a>, for example.</p><p>Once serialization is taken care of, the client itself needs to actually call the correct API endpoints. To do this, we update the code to create an HTTP client with the <code class="language-html highlighter-rouge">reqwest</code> library, serialize the data as JSON, and then send the HTTP requests to the appropriate API endpoint. You can see how that is done in the diff <a href="https://github.com/XDgov/privacy-preserving-model-auditing-demo/commit/14719b4f50b502b9a4f0408ef144c53d926bed7d#diff-4cc788698e80640ce0458d1d1ceeef8920b47f2094eacec6a73c50c52b298117R139">here</a>. Here is also a small code snippet that shows a request to the REST API, this one asking for the results of the computation from the server:</p><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="k">let</span> <span class="n">proto_stats</span> <span class="o">=</span> <span class="n">http_client</span><span class="nf">.post</span><span class="p">(</span>
        <span class="nd">format!</span><span class="p">(</span><span class="s">"{}/v1/recv_stats"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_pre</span><span class="nf">.unwrap</span><span class="p">())</span>
    <span class="p">)</span><span class="nf">.send</span><span class="p">()</span><span class="k">.await</span><span class="o">?</span><span class="py">.json</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Stats</span><span class="o">&gt;</span><span class="p">()</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></div><p>Compare that to what the same code looked like using gRPC instead:</p><div class="language-rust highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="k">let</span> <span class="n">proto_stats</span> <span class="o">=</span> <span class="nn">rpc_client</span><span class="p">::</span><span class="nf">recv_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">client_context</span><span class="p">)</span>
        <span class="k">.await</span><span class="o">?</span>
        <span class="nf">.into_inner</span><span class="p">();</span>
</code></pre></div></div><p>From a code simplicity standpoint, the REST API requests do add a little bit of cruft to the code compared to the gRPC calls, but overall it’s not a huge change. Ultimately you might actually be able to write a code generation routine that would do this kind of translation automatically, but you would still need to tend to details like the correct serialization format for the various buffers defined in the code.</p><h2 id="configuring-the-networking-on-cloudgov">Configuring the networking on cloud.gov</h2><p>Now that our client is ready to communicate with the proxy server on cloud.gov, our last step is ensuring that the proxy server actually has the permission to communicate with the RPC server that is running the computation. While this was not the trickiest part of the process, it did require understanding a bit about how CloudFoundry networking permissions work. In the end, two commands are needed to get the job done.</p><p>First, we need to allow the proxy server application to send traffic to the internal RPC server:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="syntax"><code>cf add-network-policy <span class="nv">$PROXY_PREFIX</span> <span class="nv">$RPC_PREFIX</span> <span class="nt">-s</span> dev <span class="nt">-o</span> census-xd-pets-prototyping <span class="nt">--protocol</span> tcp <span class="nt">--port</span> 8080
</code></pre></div></div><p>Then, we need to allow our RPC server to receive internal traffic via HTTP2:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="syntax"><code>cf map-route <span class="nv">$RPC_PREFIX</span> apps.internal <span class="nt">--hostname</span> <span class="nv">$RPC_PREFIX</span> <span class="nt">--app-protocol</span> http2
</code></pre></div></div><p>That should do it! It might seem a bit silly to have gone through all this work to just get around the fact that we could not communicate externally via HTTP2 even though we could internally, but I still think it’s a useful and illustrative example of how to make your gRPC-based app work in different environments.</p><p>That’s all for this post. In the next post, I will go into more detail on how the final model auditing demo actually works.</p></div></div><div class="news-image-container tablet:grid-col-4"> <img src="https://uscensusbureau.github.io/assets/img/news/privacy-preserving-model-auditing-demo-technical-deep-dive.jpg" alt="Privacy-preserving model auditing demo: technical deep dive"></div></div></article></section><section class="more-news"><div class="grid-container"><div class="breadcrumb">More News</div><div class="grid-row grid-gap-lg"><div class="tablet:grid-col-6"><div class="news-item news-item-sm grid-row grid-gap-lg"><div class="grid-col-4"> <a href="/news/new-geo-classification-working-paper/"> <img class="news-img" src="/assets/img/news/xd-team-members-publish-working-paper-on-predicting-census-block-status-classifications.jpg" alt="Dashboard showing various block-level classifications"> </a></div><div class="grid-col-8"><h3> <a href="/news/new-geo-classification-working-paper/">xD Team Members Publish Working Paper on Predicting Census Block-Status Classifications</a></h3><a class="square-link" href="/news/new-geo-classification-working-paper/">Learn More<span class="visually-hidden"> about xD Team Members Publish Working Paper on Predicting Census Block-Status Classifications</span></a></div></div></div><div class="tablet:grid-col-6"><div class="news-item news-item-sm grid-row grid-gap-lg"><div class="grid-col-4"> <a href="/news/causality-paper-announcement/"> <img class="news-img" src="/assets/img/news/xd-team-member-publishes-causality-for-trustworthy-artificial-intelligence-status-challenges-and-perspectives-in-acm-computing-surveys.jpg" alt="Causality for Trustworthy AI"> </a></div><div class="grid-col-8"><h3> <a href="/news/causality-paper-announcement/">xD Team Member Publishes "Causality for Trustworthy Artificial Intelligence: Status, Challenges, and Perspectives" in ACM Computing Surveys</a></h3><a class="square-link" href="/news/causality-paper-announcement/">Learn More<span class="visually-hidden"> about xD Team Member Publishes "Causality for Trustworthy Artificial Intelligence: Status, Challenges, and Perspectives" in ACM Computing Surveys</span></a></div></div></div></div></div></section><!--<section class="hiring"><div class="grid-container"><div class="breadcrumb">We’re Hiring</div><h2> Join us in discovering new and exciting ways to make a difference.</h2><a class="usa-button usa-button-black" href="/apply">Apply Now</a></div></section>--></main><footer role="contentinfo" class="usa-footer"><div class="usa-footer__primary-section"><div class="grid-container"><div class="grid-row grid-gap"><div class="col-6 tablet:grid-col-4"> <a class="census-logo-footer" href="https://www.census.gov/" target="_blank"> <img src="/assets/img/logos/census.png" alt="U.S. Census Bureau"> </a></div><div class="col-6 tablet:grid-col-8 grid-row"><div class="col-12 tablet:grid-col-6"><h4>Helpful Links</h4><nav class="usa-footer_nav"><ul class="usa-list usa-list--unstyled"><li> <a class=" usa-nav-link " href="/about/"> <span>About</span> </a><li> <a class=" usa-nav-link " href="/projects/"> <span>Projects</span> </a><li> <a class=" usa-nav-link " href="/news/"> <span>News</span> </a></ul></nav></div><div class="col-12 tablet:grid-col-6"><h4>Get the Latest</h4><p class="color-white"> Keep up to date with xD’s work and the Emerging Technology Fellowship by signing up for updates.</p><p> <a href="https://public.govdelivery.com/accounts/USCENSUS/signup/34927" target="_blank" class="usa-button usa-button-white"><span class="visually-hidden">Subscribe to the </span>Mailing List</a></p></div></div></div><div class="footer-bottom"> View our <a href="/privacy-policy">Privacy Policy</a><div class="footer-seperator">•</div>Find Us on <a href="https://github.com/XDgov/">GitHub</a></div></div></div></footer>
